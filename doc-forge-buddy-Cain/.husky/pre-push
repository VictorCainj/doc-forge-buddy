#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook para validaÃ§Ãµes de qualidade antes do push
echo "ğŸš€ Executando pre-push hooks para validaÃ§Ã£o de qualidade..."

# Verificar se Ã© uma branch de feature ou hotfix
current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

echo "ğŸ“Š Branch atual: $current_branch"

# Para branches de feature/hotfix, executar validaÃ§Ãµes mais rigorosas
if [[ "$current_branch" =~ ^(feature|hotfix|bugfix)/ ]] || [[ "$current_branch" =~ ^[0-9]+-.+$ ]]; then
    echo "ğŸ” Executando validaÃ§Ãµes completas para branch de feature/hotfix..."
    
    # Verificar se todas as dependÃªncias estÃ£o instaladas
    echo "ğŸ“¦ Verificando dependÃªncias..."
    if [ ! -d "node_modules" ]; then
        echo "âŒ DependÃªncias nÃ£o estÃ£o instaladas. Execute 'npm install' primeiro."
        exit 1
    fi
    
    # Executar type check
    echo "ğŸ” Executando TypeScript type check..."
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
        echo "âŒ TypeScript type check falhou! Corrija os erros antes de fazer push."
        exit 1
    fi
    
    # Executar ESLint
    echo "ğŸ” Executando ESLint..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ ESLint falhou! Corrija os erros antes de fazer push."
        exit 1
    fi
    
    # Executar testes unitÃ¡rios
    echo "ğŸ§ª Executando testes unitÃ¡rios..."
    npm run test:unit
    if [ $? -ne 0 ]; then
        echo "âŒ Testes unitÃ¡rios falharam! Corrija os testes antes de fazer push."
        exit 1
    fi
    
    # Executar testes de integraÃ§Ã£o
    echo "ğŸ”— Executando testes de integraÃ§Ã£o..."
    npm run test:integration
    if [ $? -ne 0 ]; then
        echo "âŒ Testes de integraÃ§Ã£o falharam! Corrija os testes antes de fazer push."
        exit 1
    fi
    
    # Verificar cobertura de testes
    echo "ğŸ“Š Verificando cobertura de testes..."
    npm run validate-coverage
    if [ $? -ne 0 ]; then
        echo "âŒ Cobertura de testes insuficiente! Melhore os testes antes de fazer push."
        exit 1
    fi
    
    # Executar build de teste
    echo "ğŸ—ï¸  Executando build de teste..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ Build falhou! Corrija os erros de build antes de fazer push."
        exit 1
    fi
    
    # Executar testes E2E
    echo "ğŸŒ Executando testes E2E..."
    npm run test:e2e
    if [ $? -ne 0 ]; then
        echo "âŒ Testes E2E falharam! Corrija os testes antes de fazer push."
        exit 1
    fi
    
    echo "âœ… Todas as validaÃ§Ãµes foram executadas com sucesso!"
    
else
    echo "â„¹ï¸  Pulando validaÃ§Ãµes rigorosas para branch: $current_branch"
    echo "ğŸ” Executando apenas validaÃ§Ãµes bÃ¡sicas..."
    
    # Executar apenas type check e lint
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
        echo "âŒ TypeScript type check falhou!"
        exit 1
    fi
    
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ ESLint falhou!"
        exit 1
    fi
    
    echo "âœ… ValidaÃ§Ãµes bÃ¡sicas executadas com sucesso!"
fi

echo "ğŸ‰ Pre-push hooks concluÃ­dos com sucesso!"