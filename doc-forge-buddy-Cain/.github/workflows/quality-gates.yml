name: Quality Gates & Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # NecessÃ¡rio para coverage comparisons
    
    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” Lint check
      run: npm run lint
      continue-on-error: false
    
    - name: ğŸ“ Type check
      run: npm run type-check
      continue-on-error: false
    
    - name: ğŸ§ª Run unit tests
      run: npm run test:unit
      continue-on-error: false
    
    - name: ğŸ“Š Run tests with coverage
      run: npm run test:coverage
      continue-on-error: false
    
    - name: ğŸ“‹ Check coverage thresholds
      run: npm run coverage:threshold
      continue-on-error: false
    
    - name: ğŸ­ Run E2E tests
      run: npm run test:e2e
      continue-on-error: false
      env:
        CI: true
    
    - name: ğŸ“ˆ Upload coverage to Codecov
      if: matrix.node-version == 20
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/coverage-final.json
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: ğŸ“Š Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports-node-${{ matrix.node-version }}
        path: |
          coverage/
          coverage-final.json
        retention-days: 7
    
    - name: ğŸ’¬ Comment PR with coverage
      if: github.event_name == 'pull_request' && matrix.node-version == 20
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: coverage-report
        path: coverage/coverage-final.json
        use: codecov/codecov-action@v3
    
    - name: ğŸš€ Performance budget check
      if: github.ref == 'refs/heads/main'
      run: npm run test:budgets
      continue-on-error: true
    
    - name: ğŸ”’ Security audit
      run: npm run security:audit
      continue-on-error: true

  build-and-deploy:
    needs: quality-gates
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build production
      run: npm run build:production
      env:
        CI: true
    
    - name: ğŸ“Š Bundle analysis
      run: npm run ci:bundle-analysis
    
    - name: ğŸ“ˆ Upload bundle analysis
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis
        path: dist/bundle-analysis.html
        retention-days: 30

  slack-notifications:
    needs: [quality-gates, build-and-deploy]
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'pull_request')
    
    steps:
    - name: Send Slack notification on success
      if: needs.quality-gates.result == 'success' && needs.build-and-deploy.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'âœ… Quality gates passed! Build e2e successful.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Send Slack notification on failure
      if: needs.quality-gates.result == 'failure' || needs.build-and-deploy.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'âŒ Quality gates failed! Check the build logs.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}